name: Release (nightly)
on:
  schedule:
    - cron: '23 23 * * *'

permissions: {}

jobs:
  check_nightly:
    if: vars.BUILD_NIGHTLY
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      commit: ${{ steps.check_for_new_commits.outputs.commit }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      
      - name: Sync with upstream
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git remote add upstream https://github.com/yt-dlp/yt-dlp.git || true
          git fetch upstream
          
          # Try to merge upstream changes
          if ! git merge upstream/master --no-edit; then
            echo "Merge conflicts detected, attempting auto-resolution..."
            
            # For most conflicts, prefer upstream version (theirs)
            git checkout --theirs .
            git add -A
            
            # But keep our custom extractors if they exist
            if [ -f "yt_dlp/extractor/boy18tube.py" ]; then
              git checkout --ours yt_dlp/extractor/boy18tube.py 2>/dev/null || true
            fi
            if [ -f "yt_dlp/extractor/erome.py" ]; then
              git checkout --ours yt_dlp/extractor/erome.py 2>/dev/null || true
            fi
            # Also keep our modified RedGifs extractor if it exists
            if [ -f "yt_dlp/extractor/redgifs.py" ]; then
              git checkout --ours yt_dlp/extractor/redgifs.py 2>/dev/null || true
            fi
            
            # For _extractors.py, merge both versions' imports
            if git diff --name-only --diff-filter=U | grep -q "_extractors.py"; then
              echo "Merging extractor registrations..."
              # Take upstream version as base, we'll add our extractors back in release-master
              git checkout --theirs yt_dlp/extractor/_extractors.py
            fi
            
            git add -A
            git commit -m "Merge upstream changes (auto-resolved conflicts)" --no-edit || true
          fi
          
          # Explicitly name the branch ref so the push is not ambiguous even if a tag named master exists
          git push origin HEAD:refs/heads/master
      
      - name: Check for new commits
        id: check_for_new_commits
        run: |
          relevant_files=(
            "yt_dlp/*.py"
            ':!yt_dlp/version.py'
            "bundle/*.py"
            "bundle/docker/compose.yml"
            "bundle/docker/linux/*"
            "pyproject.toml"
            "Makefile"
            ".github/workflows/build.yml"
            ".github/workflows/release.yml"
            ".github/workflows/release-nightly.yml"
          )
          echo "commit=$(git log --format=%H -1 --since="24 hours ago" -- "${relevant_files[@]}")" | tee "$GITHUB_OUTPUT"

  release:
    needs: [check_nightly]
    if: ${{ needs.check_nightly.outputs.commit }}
    permissions:
      contents: write
      id-token: write  # mandatory for trusted publishing
    uses: ./.github/workflows/release.yml
    with:
      prerelease: true
      source: ${{ (github.repository != 'yt-dlp/yt-dlp' && vars.NIGHTLY_ARCHIVE_REPO) || 'nightly' }}
      target: 'nightly'
    secrets: inherit

  publish_pypi:
    needs: [release]
    if: vars.NIGHTLY_PYPI_PROJECT
    permissions:
      id-token: write  # mandatory for trusted publishing
    runs-on: ubuntu-latest
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v7
        with:
          path: dist
          name: build-pypi
      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          verbose: true
